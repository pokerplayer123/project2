<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Pears</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js"></script>
</head>

<template name="layout">
  {{ >nav }}

  <div class="container">
    {{#if currentUser}}
    <!-- -->
    {{> yield }}
    <!-- -->
    {{else}}
    <!-- -->
    {{> atForm}}
    <!-- -->
    {{/if}}
  </div>

  <script>
    $(document).ready(function () {
      $(".button-collapse").sideNav();
      $(".dropdown-button").dropdown();
      // $('.modal').modal();
    });
  </script>
</template>


<template name="nav">

  <nav class="grey darken-4 nav-extended">
    <div class="nav-wrapper">
      <img class="logo" width="55" height="55" src="/img/pear-logo-white-bg.png">
      <a href="/" class="brand-logo">&nbsp;&nbsp;Pears&nbsp;&nbsp;</a>
      <a href="#" data-activates="mobile-demo" class="button-collapse">
        <i class="material-icons">menu</i>
      </a>
      <ul id="nav-mobile" class="right hide-on-med-and-down">
        {{#if currentUser}} {{#if isTutor}}
        <li>
          <a href="/my-tutorials">Classes</a>
        </li>
        <li>
          <a href="/students">Students</a>
        </li>
        {{/if}}
        <li>
          <a href="/editProfile">Edit Profile</a>
        </li>
        {{/if}}
        <li>
          {{> atNavButton}}
        </li>
      </ul>
      <ul class="side-nav" id="mobile-demo">
        {{#if currentUser}}
        <li>
          <a href="/">Tutorials</a>
        </li>
        {{#if isTutor}}
        <li>
          <a href="/my-tutorials">My Tutorials</a>
        </li>
        {{/if}}
        <li>
          <a href="/editProfile">Edit Profile</a>
        </li>
        {{/if}}
        <li>
          {{> atNavButton}}
        </li>
      </ul>
    </div>
  </nav>

</template>

<template name="search">
  <div class="input-field">
    <i class="material-icons prefix">search</i>
    <!-- input -->
    {{> EasySearch.Input index=tutorialsIndex attributes=searchInputAttr }}
    <label for="search">Search</label>

  </div>

  <div class="row">
    {{#EasySearch.Each index=tutorialsIndex}} {{> tutorial }} {{/EasySearch.Each}}
  </div>

  {{> EasySearch.LoadMore index=tutorialsIndex}}

  <!-- -->
  {{#EasySearch.IfNoResults index=tutorialsIndex}}
  <div class="card blue-grey darken-1">
    <div class="card-content white-text">
      <p>No results found!</p>
    </div>
  </div>
  {{/EasySearch.IfNoResults}}
</template>

<template name="tutorials">
  <h4>Tutorials</h4>
  <br>

  <!-- Search ocntains the actual data now-->
  {{> search }}
  <!-- finish search-->

  {{#if isTutor}}
  <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
    <a class="btn-floating btn-large waves-effect waves-light align-right modal-trigger" href="/tutorials/add">
      <i class="material-icons">add</i>
    </a>
  </div>
  {{/if}}
</template>

<template name="tutorial">
  <div class="col s12 m6 l4">
    <div class="card sticky-action">
      <div class="card-image">
        <img src="/img/unsw-logo-large.jpg">
      </div>
      <div class="card-content">
        <span class="card-title activator grey-text text-darken-4">{{tutorialName}}
          <i class="material-icons right">more_vert</i>
        </span>
      </div>
      <div class="card-reveal">
        <span class="card-title grey-text text-darken-4">{{tutorialName}}
          <i class="material-icons right">close</i>
        </span>
        <dl class="row">
          <dt class="col s4">
            <b>Course:</b>
          </dt>
          <dd class="col s8">{{courseName}}</dd>
        </dl>
        <dl class="row">
          <dt class="col s4">
            <b>Start:</b>
          </dt>
          <dd class="col s8">{{startDate}} {{startTime}}</dd>
        </dl>
        <dl class="row">
          <dt class="col s4">
            <b>End:</b>
          </dt>
          <dd class="col s8">{{endDate}} {{endTime}}</dd>
        </dl>
      </div>
      <div class="card-action">
        <a class="btn" href="/tutorials/{{_id}}">Detail</a>
        <!--  -->
        {{#if isOwner}}
        <a class="delete-tutorial btn red">
          <i class="material-icons">delete</i>
        </a>
        <!--  -->
        {{/if}}
      </div>
    </div>
  </div>

</template>

<template name="myTutorials">
  <h4>My Tutorials</h4>
  <br>

  <div class="row">
    {{#each tutorials}} {{> tutorial }} {{/each}}
  </div>

  <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
    <a class="btn-floating btn-large waves-effect waves-light align-right modal-trigger" href="/tutorials/add">
      <i class="material-icons">add</i>
    </a>
  </div>
</template>

<template name="addTutorial">
  <!--Modal Structure -->
  <div id="addModal" class="">
    <div class="modal-content">
      <h4>Create Tutorial</h4>
      <form class="add-form">
        <input type="text" name="tutorialName" placeholder="Tutorial name...">
        <input type="text" name="courseName" placeholder="Course name...">
        <input type="text" name="password" placeholder="Room password...">
        <input type="date" name="startDate" placeholder="Set the start date...">
        <input type="date" name="endDate" placeholder="Set the end date...">
        <input type="time" name="startTime" placeholder="Start time...">
        <input type="time" name="endTime" placeholder="End time...">
        <button class="btn waves-effect waves-light" type="submit" name="action">Submit
          <i class="material-icons right">send</i>
        </button>
      </form>
    </div>
  </div>
</template>

<template name="tutorialDetail">
  <br>
  <div class="row">
    <div class="col s12 m5 l4">
      <div class="card">
        <div class="card-image">
          <img src="/img/unsw-logo-large.jpg">
          <span class="card-title">{{tutorialName}}</span>
        </div>
        <div class="card-content">
          <dl class="row">
            <dt class="col s4">
              <b>Tutorial:</b>
            </dt>
            <dd class="col s8">{{tutorialName}}</dd>
          </dl>
          <dl class="row">
            <dt class="col s4">
              <b>Course:</b>
            </dt>
            <dd class="col s8">{{courseName}}</dd>
          </dl>
          <dl class="row">
            <dt class="col s4">
              <b>Start:</b>
            </dt>
            <dd class="col s8">{{startDate}} {{startTime}}</dd>
          </dl>
          <dl class="row">
            <dt class="col s4">
              <b>End:</b>
            </dt>
            <dd class="col s8">{{endDate}} {{endTime}}</dd>
          </dl>
        </div>
      </div>
    </div>
    <div class="col s12 m7 l8">

      <p class="red-text" id="errorMsg"></p>
      <!-- -->

      <div id="password-section" style="display: {{passwordSectionStyle}}">
        <h5>Enter password to join this room</h5>
        <br>
        <form id="join-room">
          <div class="input-field">
            <input id="room-password" name="room-password" type="password" required>
            <label for="room-password">Room Password</label>
          </div>
          <button type="submit" class="btn waves-effect waves-light">Join</button>
        </form>
      </div>

      <div id="detail-section" style="display: {{detailSectionStyle}}" data-tutorial-id="{{_id}}" data-tutorial-owner="{{owner}}">

        {{#if isOwner }}
        <div class="right-align">
          <a class="btn waves-effect waves-light" href="/tutorials/{{_id}}/tutor-dashboard">Tutor Dashboard</a>
        </div>
        {{/if}}

        <div class="left-align">
          <h4>Request List</h4>
          {{#if isTutor }}
          <!-- -->
          {{else}} {{/if}}
          <br>
          <!-- -->
          {{#if hasRequests}}
          <ul class="collapsible" data-collapsible="expandable">
            {{#each requests}} {{> requestItem }} {{/each}}
          </ul>
          {{else}}
          <p>There are no requests yet.</p>

          {{/if}}
          <div class="right-align">
            <a class="btn waves-effect waves-light btn modal-trigger" id="create-request" href="#create-request-modal">New Request</a>
          </div>
        </div>
        <div class="card">
          <div class="card-image waves-effect waves-block waves-light">
            <img width="500" height="300" src="/img/night-sky.jpg">

            <span class="card-title">
              <h4> Forum </h4>
            </span>
          </div>
          <div class="card-content right-align">
            <a class="btn-large btn-floating waves-effect waves-blue right-align" id="view-forum" href="/tutorials/forum/{{_id}}">
              <i class="material-icons">pageview</i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="create-request-modal" class="modal">
    <form id="create-request-form">
      <div class="modal-content">
        <h4>Create New Request</h4>
        <div class="row">
          <div class="input-field col s12">
            <input id="question" name="question" type="text" required>
            <label for="question">Question</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            <textarea id="desc" name="desc" class="materialize-textarea" required></textarea>
            <label for="desc">Issue Description</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a class="modal-action modal-close waves-effect btn-flat">Close</a>
        <button type="submit" id="submit-request" class="modal-action waves-effect btn-flat">Submit</button>
      </div>
    </form>
  </div>

  <script>
    $('.collapsible').collapsible();
  </script>
</template>

<template name="requestItem">
  <li style="position: relative">
    {{#if isRequestOwnerOrTutorialOwner }}
    <a class="btn-floating red delete-request">
      <i class="material-icons">close</i>
    </a>
    <!-- -->
    {{/if}}
    <div class="collapsible-header">
      <i class="material-icons">question_answer</i>
      <span>
        <b>{{question}}</b>
      </span>
      <span style="flex-grow: 1;"></span>
      <span>{{ownerZid}}</span>
      <span class="date-label">{{fromNow}}</span>
      <i class="material-icons">keyboard_arrow_down</i>
    </div>
    <div class="collapsible-body" style="padding: 0.5rem 1rem">
      <p>
        <b>Owner zID:</b> {{ownerZid}}
      </p>
      <p>
        <b>Description:</b>
        <br> {{desc}}
      </p>
    </div>
  </li>
</template>

<template name="editProfile">
  <!--Modal Structure -->
  <div id="editProfile" class="">
    <div class="modal-content">
      <h4>Edit Profile</h4>
      <form class="edit-profile-form">
        <label>zID</label>
        <input type="text" name="zid" value="{{userProfile.zid}}" placeholder="zId">
        <label>Firstname</label>
        <input type="text" name="firstname" value="{{userProfile.firstname}}" placeholder="firstname">
        <label>Lastname</label>
        <input type="text" name="lastname" value="{{userProfile.lastname}}" placeholder="lastname">
        <label>Degree</label>
        <input type="text" name="degree" value="{{userProfile.degree}}" placeholder="degree">
        <label>Gender</label>
        <select name="gender" style="display: block">
          <option value="male" {{compareGender 'male'}}>Male</option>
          <option value="female" {{compareGender 'female'}}>Female</option>
        </select>
        <label>Points</label>
        <textarea readonly name="points" value="{{userProfile.points}}"></textarea>


        <!--  -->
        {{#if isTutor}}
        <!--  -->
        <label>Consultation Start Time</label>
        <input type="time" name="consultationStart" value="{{userProfile.consultationStart}}" placeholder="Consultation Start Time">
        <label>Consultation End Time</label>
        <input type="time" name="consultationEnd" value="{{userProfile.consultationEnd}}" placeholder="Consultation End Time">
        <!--  -->
        {{/if}}
        <!--  -->
        <br>
        <button class="btn waves-effect waves-light" type="submit" name="action">Submit
          <i class="material-icons right">send</i>
        </button>
      </form>
    </div>
  </div>
</template>

<template name="forum">
  <div class="col s12 m7 l8">

    <h4>{{tutorial.tutorialName}}</h4>
    <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
      <a class="btn-large btn-floating waves-effect waves-light btn" id="create-subforum" href="#create-subforum-modal">
        <i class="material-icons">add</i>
      </a>
    </div>

    <br>
    <!--  -->
    {{#if hasSubforums}}
    <!--  -->
    {{#each subforums}}
    <!--  -->
    {{> subforumCard}}
    <!--  -->
    {{/each}}
    <!--  -->
    {{else}}
    <ul class="collection with-header">
      <li class="collection-header">
        <h4>Sub-Forums</h4>
      </li>
      <li class="collection-item">
        <div>Week1
          <a href="#!" class="secondary-content"></a>
        </div>
      </li>
      <li class="collection-item">
        <div>Week2
          <a href="#!" class="secondary-content"></a>
        </div>
      </li>
      <li class="collection-item">
        <div>Week3
          <a href="#!" class="secondary-content"></a>
        </div>
      </li>
      <li class="collection-item">
        <div>Week4
          <a href="#!" class="secondary-content"></a>
        </div>
      </li>
    </ul>
    {{/if}}
  </div>

  <div id="create-subforum-modal" class="modal">
    <form id="create-subforum-form">
      <div class="modal-content">
        <h4>Create New Subforum</h4>
        <div class="row">
          <div class="input-field col s12">
            <input id="subforum" name="subforum" type="text" required>
            <label for="subforum">Sub Forum name</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            <textarea id="description" name="description" type="text" class="materialize-textarea" required></textarea>
            <label for="description">Forum description</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a class="modal-action modal-close waves-effect waves-light btn-flat">Close</a>
        <button type="submit" id="submit-subforum" onclick="increment" class="modal-action waves-effect waves-light btn-flat">Submit</button>
      </div>
    </form>
  </div>

  <script>
    $('.collapsible').collapsible();
  </script>

</template>

<template name="subforumCard">
  <div class="col s12 m7">
    <h2 class="header">{{subforumname}}</h2>
    <div class="card horizontal">
      <div class="card-image">
        <img src="/img/technical-PM.jpg">
      </div>
      <div class="card-stacked">
        <div class="card-content">
          <p>{{description}}</p>
        </div>
        <div class="card-action">
          <a href="/tutorials/forum/{{tutorialId}}/subforum/{{_id}}">View Subforum</a> {{#if isOwner}}
          <a href="#" class="delete-subforum">Delete</a> {{/if}}
        </div>
      </div>
    </div>
  </div>
</template>

<template name="subforum">
  <div class="col s12 m7">
    <h2 class="header text">{{subforum.subforumname}}</h2>
    <p>{{subforum.description}}</p>

    {{#if isOwner}}
    <div class="right-align">
      {{#if isSubforumClosed}}
      <!-- <a href="#" class="waves-effect waves-light btn open-subforum">Open This Question</a> -->
      <!--  -->
      {{else}}
      <!-- <a href="#" class="waves-effect waves-light btn close-subforum">Close This Question</a> -->
      <!--  -->
      {{/if}}
    </div>
    {{/if}}

    <br>

    <hr>
    <!--  -->
    {{#each threads}} {{> threadCard }} {{/each}}
    <!--  -->
    {{#if isSubforumClosed}}
    <!--  -->
    {{else}}
    <div class="card darken-1">
      <div class="card-content ">
        <form id="create-thread">
          <p>Post a new thread</p>
          <div class="input-field">
            <textarea id="answer" name="answer" class="materialize-textarea"></textarea>
            <label for="answer">Write your question here</label>
          </div>
          <button type="submit" class="waves-effect waves-light waves-ripple waves-blue btn">submit</button>
        </form>
      </div>
    </div>
    <!--  -->
    {{/if}}
  </div>
</template>

<template name="threadCard">
  <div class="card darken-1">
    <div class="card-content ">
      <p>{{question}}</p>

      {{#if isClosed}}
      <div style="position: absolute;
        top: 3px;
        right: 5px;
        background: #ee6e73;
        padding: 10px;
        color: #fff;
        border-radius: 3px;">
        <p>Closed</p>
      </div>
      {{/if}}

      <div class="small">
        <p class="right-align">
          <i class="small material-icons right">access_time</i>{{fromNow}}</p>
        <p class="right-align">by {{ownerName}}</p>
      </div>
    </div>
    <div class="card-action">
      <a href="/tutorials/forum/{{tutorialId}}/subforum/{{subforumId}}/thread/{{_id}}">View Thread</a>
      {{#if isSubforumOwner}}
      <a class="delete-thread" href="#">Delete</a>
      {{/if}}
    </div>
  </div>
  <hr>
</template>


<template name="thread">
  <div class="col s12">
    <h2 class="header text">{{thread.question}}</h2>
    <p class="right-align">created {{fromNow}}</p>
    <p class="right-align">from subforum
      <b>{{subforum.subforumname}}</b>
    </p>

    {{#if isOwner}}
    <div class="right-align">
      {{#if isThreadClosed}}
      <a href="#" class="waves-effect waves-light btn open-thread">Open this thread</a>
      <!--  -->
      {{else}}
      <a href="#" class="waves-effect waves-light btn close-thread">Close this thread</a>
      <!--  -->
      {{/if}}
    </div>
    {{/if}}

    <br>

    <hr>
    <!--  -->
    {{#each answers}} {{> answerCard }} {{/each}}
    <!--  -->
    {{#if isThreadClosed}}
    <!--  -->
    {{else}}
    <div class="card darken-1">
      <div class="card-content ">
        <form id="create-answer-form">
          <p>Your Answer</p>
          <div class="input-field">
            <textarea id="answer" name="answer" class="materialize-textarea"></textarea>
            <label for="answer">Write your response here</label>
          </div>
          <button type="submit" class="waves-effect waves-light waves-ripple waves-blue btn">Submit</button>
        </form>
      </div>
    </div>
    <!--  -->
    {{/if}}
  </div>

</template>


<template name="answerCard">
  <div class="card darken-1">
    <div class="card-content ">
      <p>{{answer}}</p>
      {{#if isBestAnswer}}
      <div style="position: absolute;
        top: 3px;
        right: 5px;
        background: #ee6e73;
        padding: 10px;
        color: #fff;
        border-radius: 3px;">
        <p>Best answer</p>
      </div>
      {{/if}}
      <div class="small">
        <p class="right-align">
          <i class="small material-icons right">access_time</i>{{fromNow}}</p>
        <p class="right-align">by {{ownerName}}</p>
      </div>
      <div id="like" class="small">
        <a class="btn">
          <i class="small material-icons left">thumb_up</i>like</a>
        <a class="btn">
          <i class="small material-icons left">reply</i>reply</a>

        {{#if isTutorialOwner }}
        <div class="stars">
          <input class="star star-5" id="star-5-{{_id}}" type="radio" name="star-{{_id}}" value="5" />
          <label class="star star-5" for="star-5-{{_id}}"></label>
          <input class="star star-4" id="star-4-{{_id}}" type="radio" name="star-{{_id}}" value="4" />
          <label class="star star-4" for="star-4-{{_id}}"></label>
          <input class="star star-3" id="star-3-{{_id}}" type="radio" name="star-{{_id}}" value="3" checked />
          <label class="star star-3" for="star-3-{{_id}}"></label>
          <input class="star star-2" id="star-2-{{_id}}" type="radio" name="star-{{_id}}" value="2" />
          <label class="star star-2" for="star-2-{{_id}}"></label>
          <input class="star star-1" id="star-1-{{_id}}" type="radio" name="star-{{_id}}" value="1" />
          <label class="star star-1" for="star-1-{{_id}}"></label>
        </div>
        {{/if}}

      </div>
    </div>
    {{#if isOwner}}
    <div class="card-action">
      {{#if isThreadOwner}}
      <!--  -->
      {{#if isBestAnswer}}
      <!--  -->
      {{else}}
      <a class="pick-best-answer" href="#">This is best answer</a>
      <!--  -->
      {{/if}}
      <!--  -->
      {{/if}}
      <a class="delete-answer" href="#">Delete</a>
    </div>
    {{/if}}
  </div>
  <hr>
</template>

<template name="tutorDashboard">
  <br>
  <div class="row">
    <div class="col s12 m6">
      <div class="card">
        <div class="card-content">
          <canvas id="topStudentsGraph" width="400" height="300"></canvas>
        </div>
      </div>
      <br>
      <div class="card">
        <div class="card-content">
          <canvas id="bottomStudentsGraph" width="400" height="300"></canvas>
        </div>
      </div>
    </div>
    <div class="col s12 m6">
      <h4>Request List</h4>
      {{#if hasRequests}}
      <ul class="collapsible" data-collapsible="expandable">
        {{#each requests}} {{> requestItem }} {{/each}}
      </ul>
      {{else}}
      <p>There are no requests yet.</p>

      {{/if}}
    </div>
  </div>



  <script>
    $('.collapsible').collapsible();

    var allStudents = JSON.parse('{{students}}');
    allStudents.sort(function (a, b) {
      return b.profile.points - a.profile.points;
    });

    var topStudents = allStudents.slice(0, 5);
    var bottomStudents = allStudents.slice(-5);

    var topCtx = document.getElementById("topStudentsGraph").getContext('2d');
    var topStudentsChart = new Chart(topCtx, {
      type: 'bar',
      data: {
        labels: topStudents.map(function (stu) {
          return stu.profile.firstname + ' ' + stu.profile.lastname
        }),
        datasets: [{
          label: 'Top 5 students',
          data: topStudents.map(function (stu) {
            return stu.profile.points
          }),
          backgroundColor: topStudents.map(function (stu) {
            return '#FFCD00'
          })

        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });

    var bottomCtx = document.getElementById("bottomStudentsGraph").getContext('2d');
    var bottomStudentsChart = new Chart(bottomCtx, {
      type: 'bar',
      data: {
        labels: bottomStudents.map(function (stu) {
          return stu.profile.firstname + ' ' + stu.profile.lastname
        }),
        datasets: [{
          label: 'Bottom 5 students',
          data: bottomStudents.map(function (stu) {
            return stu.profile.points
          }),
          backgroundColor: bottomStudents.map(function (stu) {
            return '#FFCD00'
          })
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });
  </script>

</template>


<template name="students">
  {{# each users}}
  <ul class="collection">
    <li class="collection-item avatar">
      <i class="material-icons circle large">person</i>
      <span class="title">{{profile.firstname}} {{profile.lastname}}</span>
      <p>{{profile.zid}}
        <br> {{profile.degree}}
      </p>
    </li>
  </ul>
  {{/each}}
</template>